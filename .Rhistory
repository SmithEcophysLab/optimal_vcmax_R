model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
source('calc_optimal_vcmax.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
source('calc_optimal_vcmax.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
source('calc_optimal_vcmax.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
## load model
source('calc_optimal_vcmax.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
## load model
source('calc_optimal_vcmax.R')
source('calc_vcmax_C3.R')
source('calc_vcmax_C4.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output_1 <- ifelse(pathway == "C3", calc_vcmax_C3(tg_c, z, vpdo, cao, oao, paro, q0, theta, f),
calc_vcmax_C4(tg_c, z, vpdo, cao, oao, paro, q0, theta, f))
model_output_1 <- ifelse(nutnet$photosynthetic_pathway == "C3",
calc_vcmax_C3(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391),
calc_vcmax_C4(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391))
View(model_output_1)
## load model
source('calc_optimal_vcmax.R')
source('calc_vcmax_C3.R')
source('calc_vcmax_C4.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output_1 <- ifelse(nutnet$photosynthetic_pathway == "C3",
calc_vcmax_C3(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391),
calc_vcmax_C4(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391))
View(model_output_1)
?ifelse
model_output_2 <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
## load model
source('calc_optimal_vcmax.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output_2 <- calc_optimal_vcmax(df = nutnet,
pathway = photosynthetic_pathway,
tg_c = tmp,
z = z,
vpdo = vpd,
paro = par,
cao = 391)
model_output_2 <- calc_optimal_vcmax(df = nutnet,
pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
View(nutnet)
## load model
source('calc_optimal_vcmax.R')
source('calc_vcmax_C3.R')
source('calc_vcmax_C4.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output_2 <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
View(model_output_2)
warnings()
# libraries
# install.packages('R.utils')
library(R.utils)
# load necessary functions
source('calc_vcmax_C3.R')
source('calc_vcmax_C4.R')
sourceDirectory('functions', modifiedOnly = FALSE)
calc_optimal_vcmax <- function(pathway, tg_c = 25, z = 0, vpdo = 1, cao = 400, oao = 209460,
paro = 800, q0 = 0.257, theta = 0.85, f = 0.5){
# ifelse(pathway == "C3", calc_vcmax_C3(tg_c, z, vpdo, cao, oao, paro, q0, theta, f),
#        calc_vcmax_C4(tg_c, z, vpdo, cao, oao, paro, q0, theta, f))
for(i in pathway){
if(pathway == "C3"){
# constants
R <- 8.314
c <- 0.05336251
leakiness <- 0.01
# environmental terms
patm <- calc_patm(z)
par <- calc_par(paro, z)
vpd <- calc_vpd(tg_c, z, vpdo)
ca <- cao * 1e-6 * patm
oa <- oao * 1e-6 * patm
# K and Gamma* model terms
km <- calc_km_pa(tg_c, z)
gammastar <- calc_gammastar_pa(tg_c, z)
# Coordination and least-cost hypothesis model terms
chi <- calc_chi(tg_c, z, vpdo, cao)
ci <- chi * ca # Pa
mc <- ((ci - gammastar) / (ci + km))
m <- ((ci - gammastar)/(ci + (2 * gammastar)))
omega <- calc_omega(theta = theta, c = c, m = m)
omega_star <- (1 + (omega) - sqrt((1 + (omega))^2 - (4 * theta * omega)))
# calculate q0 using Bernacchi et al. (2003) temperature response (set to 0.257 at 25C)
# q0 = -0.0805 + (0.022 * tg_c) - (0.00034 * tg_c * tg_c)
q0 = 0.25 # Bernacchi only goes down to 10C and these are much colder >> probably shouldn't use!
# calculate vcmax and jmax
vcmax <- ((q0 * par * m) / mc) * (omega_star / (8 * theta))
jvrat <- ((8 * theta * mc * omega) / (m * omega_star))
jmax <- jvrat * vcmax
# calculate vcmax and jmax at temperature = 25 C
vcmax25 <- vcmax / calc_tresp_mult(tg_c, tg_c, 25)
vpmax25 <- 0
jmax25 <- jmax / calc_jmax_tresp_mult(tg_c, tg_c, 25)
# estimate LMA
lma <- calc_lma(f = f, par = paro, temperature = tg_c, vpd_kpa = vpdo, z = z, co2 = 400)
# calculate leaf N in rubisco from predicted vcmax
nrubisco <- fvcmax25_nrubisco(vcmax25)
# calculate leaf N in bioenergetics from predicted jmax
nbioe <- fjmax25_nbioe(jmax25)
# calculate leaf N in rubisco from predicted vpmax with PEP-specific constants
npep <- fvpmax25_npep(vpmax25)
# calculate nitrogen in structural tissue from lma
nstructure <- flma_nstructure(lma)
# sum all leaf N predictions
nall <- nrubisco + nbioe + nstructure + npep
# calculate leaf N used for photosynthesis
nphoto <- nrubisco + nbioe + npep
# calculate the fraction of leaf N in rubisco out of all leaf N
nrubisco_frac <- nrubisco / nall
# calculate the fraction of leaf N for photosynthesis out of all leaf N
nphoto_frac <- nphoto / nall
leakage <- NA
chi_bs <- NA
kp <- NA
kr <- NA
cbs <- NA
chi_bs <- NA
obs <- NA
Al <- NA
Ap <- NA
Ac <- NA
vpmax <- NA
}else{
# constants
R <- 8.314
c <- 0.05336251
leakiness <- 0.01
# environmental terms
patm <- calc_patm(z)
par <- calc_par(paro, z)
vpd <- calc_vpd(tg_c, z, vpdo)
ca <- cao * 1e-6 * patm
oa <- oao * 1e-6 * patm
# K and Gamma* model terms
km <- calc_km_pa(tg_c, z)
gammastar <- calc_gammastar_pa(tg_c, z)
# calc chi
chi <- calc_chi_c4(cao, tg_c, vpd, z)
# calc ci ( = cm)
ci <- ca * chi
cm <- ci
oi <- oa * chi
# Light Limited Photosynthesis
m <- (ci - gammastar) / (ci + 2 * gammastar)
omega <- calc_omega(theta = theta, c = 0.01, m = m) # Eq. S4
omega_star <- (1 + (omega) - sqrt((1 + (omega))^2 - (4 * theta * omega)))  # Eq. 18
# calculate q0 using Bernacchi et al. (2003) temperature response (set to 0.257 at 25C)
q0 <- -0.0805 + (0.022 * tg_c) - (0.00034 * tg_c * tg_c)
Al <- q0 * par * m * omega_star / (8 * theta) # Eqn. 2.2
jmax <- q0 * par * omega
# calc kp
kp <- calc_kp_temp_pa(tg_c, z) # Eqn. 2.43
# calc kr
kr <- calc_kc_temp_pa(tg_c, z) # Eqn. 2.48
# calc ko
ko <- calc_ko_temp_pa(tg_c, z)
# calc vpmax
vpmax <- ((kp + cm)/cm) * (q0 * par * m * omega_star / (8 * theta)) # Eqn. 2.42
Ap <- vpmax * (cm / (cm + kp))
# calc cbs
leakage <- leakiness * Al
cbs <- calc_cbs(cm, leakage) # Eqn. 2.41
chi_bs <- cbs / ca
# calc obs
obs <- oi
# calc vcmax
vcmax <- (q0 * par * m * omega_star / (8 * theta)) * ((cbs + kr * (1 + obs/ko)) / (cbs - gammastar)) # Eqn. 2.47
mc <- ((cbs + kr * (1 + obs/ko)) / (cbs - gammastar))
Ac <- vcmax * ((cbs - gammastar) / (kr * (1 + obs/ko) + cbs)) # Eqn. 2.4
# calculate vcmax and jmax at temperature = 25 C
vcmax25 <- vcmax / calc_tresp_mult(tg_c, tg_c, 25)
vpmax25 <- vpmax / calc_tresp_mult(tg_c, tg_c, 25) # using vcmax parameters - find better solution
jmax25 <- jmax / calc_jmax_tresp_mult(tg_c, tg_c, 25)
# estimate LMA
lma <- calc_lma(f = f, par = paro, temperature = tg_c, vpd_kpa = vpdo, z = z, co2 = 400)
# calculate leaf N in rubisco from predicted vcmax
nrubisco <- fvcmax25_nrubisco(vcmax25)
# calculate leaf N in bioenergetics from predicted jmax
nbioe <- fjmax25_nbioe(jmax25)
# calculate leaf N in rubisco from predicted vpmax with PEP-specific constants
npep <- fvpmax25_npep(vpmax25)
# calculate nitrogen in structural tissue from lma
nstructure <- flma_nstructure(lma)
# sum all leaf N predictions
nall <- nrubisco + nbioe + nstructure + npep
# calculate leaf N used for photosynthesis
nphoto <- nrubisco + nbioe + npep
# calculate the fraction of leaf N in rubisco out of all leaf N
nrubisco_frac <- nrubisco / nall
# calculate the fraction of leaf N for photosynthesis out of all leaf N
nphoto_frac <- nphoto / nall
}
}
# output
results <- data.frame("tg_c" = tg_c,
"z" = z,
"vpdo" = vpdo,
"cao" = cao,
"paro" = paro,
"q0" = q0,
"theta" = theta,
"c" = c,
"par" = par,
"patm" = patm,
"ca" = ca,
"oa" = oa,
"vpd" = vpd,
"kp" = kp,
"kr" = kr,
"chi" = chi,
"ci" = ci,
"Leakage" = leakage,
"cbs" = cbs,
"chi_bs" = chi_bs,
"obs" = obs,
"Al" = Al,
"Ap" = Ap,
"Ac" = Ac,
"km" = km,
"gammastar" = gammastar,
"omega" = omega,
"m" = m,
"mc" = mc,
"omega_star" = omega_star,
"vcmax" = vcmax,
"vpmax" = vpmax,
"jmax" = jmax,
"vcmax25" = vcmax25,
"vpmax25" = vpmax25,
"jmax25" = jmax25,
"lma" = lma,
"nrubisco" = nrubisco,
"nbioe" = nbioe,
"npep" = npep,
"nstructure" = nstructure,
"nall" = nall,
"nphoto" = nphoto,
"nrubisco_frac" = nrubisco_frac,
"nphoto_frac" = nphoto_frac)
return(results)
}
library(ggplot2)
nutnet <- read.csv('NutNet_traits.csv')
## load model
source('calc_optimal_vcmax.R')
source('calc_vcmax_C3.R')
source('calc_vcmax_C4.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output_1 <- ifelse(nutnet$photosynthetic_pathway == "C3",
calc_vcmax_C3(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391),
calc_vcmax_C4(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391))
model_output_2 <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
View(model_output_2)
View(model_output)
View(model_output_1)
model_output_1 <- as.data.frame(ifelse(nutnet$photosynthetic_pathway == "C3",
calc_vcmax_C3(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391),
calc_vcmax_C4(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)))
model_output_1_df <- as.data.frame(model_output_1
model_output_1_df <- as.data.frame(model_output_1)
model_output_1_df <- as.data.frame(model_output_1)
View(model_output_1_df)
model_output_1 <- ifelse(nutnet$photosynthetic_pathway == "C3",
calc_vcmax_C3(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391),
calc_vcmax_C4(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391))
library (plyr)
model_output_1_df <- ldply(model_output_1, data.frame)
View(model_output_1_df)
?ldply
model_output_1 <- ifelse(nutnet$photosynthetic_pathway == "C3",
calc_vcmax_C3(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391),
calc_vcmax_C4(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391))
model_output_1_df <- ldply(model_output_1, data.frame)
library(ggplot2)
nutnet <- read.csv('NutNet_traits.csv')
## load model
source('calc_optimal_vcmax.R')
source('calc_vcmax_C3.R')
source('calc_vcmax_C4.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
View(model_output)
pred_c3 <- calc_vcmax_C3.R(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
source('calc_vcmax_C3.R')
source('calc_vcmax_C4.R')
pred_c3 <- calc_vcmax_C3.R(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
pred_c3 <- calc_vcmax_C3(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
pred_c4 <- calc_vcmax_C4(tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
View(pred_c4)
View(model_output)
View(pred_c3)
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
## load model
source('calc_optimal_vcmax.R')
source('calc_vcmax_C3.R')
source('calc_vcmax_C4.R')
sourceDirectory('functions', modifiedOnly = FALSE)
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
## load model
source('calc_optimal_vcmax.R')
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
## load model
source('calc_optimal_vcmax.R')
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
## load model
source('calc_optimal_vcmax.R')
model_output <- calc_optimal_vcmax(pathway = nutnet$photosynthetic_pathway,
tg_c = nutnet$tmp,
z = nutnet$z,
vpdo = nutnet$vpd,
paro = nutnet$par,
cao = 391)
View(model_output)
nutnet_C3 <- nutnet[photosynthetic_pathway == "C3"]
nutnet_C3 <- nutnet[photosynthetic_pathway == "C3"]
nutnet_C3 <- nutnet[nutnet$photosynthetic_pathway == "C3"]
library(dplyr)
?filter
nutnet_C3 <- dplyr::filter(nutnet, photosynthetic_pathway == "C3")
nutnet_C4 <- dplyr::filter(nutnet, photosynthetic_pathway == "C4")
model_output_C3 <- calc_optimal_vcmax(pathway = "C3",
tg_c = nutnet_C3$tmp,
z = nutnet_C3$z,
vpdo = nutnet_C3$vpd,
paro = nutnet_C3$par,
cao = 391)
model_output_C4 <- calc_optimal_vcmax(pathway = "C4",
tg_c = nutnet_C4$tmp,
z = nutnet_C4$z,
vpdo = nutnet_C4$vpd,
paro = nutnet_C4$par,
cao = 391)
View(model_output_C3)
View(model_output_C4)
nutnet_C4$lma_pred <- model_output_C4$lma
ggplot(nutnet, aes(lma_pred, lma)) + geom_point()
ggplot(nutnet_C4, aes(lma_pred, lma)) + geom_point()
nutnet_C3$lma_pred <- model_output_C3$lma
nutnet_C4$lma_pred <- model_output_C4$lma
ggplot(nutnet_C3, aes(lma_pred, lma)) + geom_point()
ggplot(nutnet_C4, aes(lma_pred, lma)) + geom_point()
ggplot(nutnet_C3, aes(lma_pred, lma)) + geom_point()
## load model
source('calc_optimal_vcmax.R')
model_output_C3 <- calc_optimal_vcmax(pathway = "C3",
tg_c = nutnet_C3$tmp,
z = nutnet_C3$z,
vpdo = nutnet_C3$vpd,
paro = nutnet_C3$par,
cao = 391)
## load model
source('calc_optimal_vcmax.R')
model_output_C3 <- calc_optimal_vcmax(pathway = "C3",
tg_c = nutnet_C3$tmp,
z = nutnet_C3$z,
vpdo = nutnet_C3$vpd,
paro = nutnet_C3$par,
cao = 391)
model_output_C4 <- calc_optimal_vcmax(pathway = "C4",
tg_c = nutnet_C4$tmp,
z = nutnet_C4$z,
vpdo = nutnet_C4$vpd,
paro = nutnet_C4$par,
cao = 391)
View(model_output_C3)
View(model_output_C4)
nutnet_C3$lma_pred <- model_output_C3$lma
nutnet_C4$lma_pred <- model_output_C4$lma
ggplot(nutnet_C3, aes(lma_pred, lma)) + geom_point()
ggplot(nutnet_C4, aes(lma_pred, lma)) + geom_point()
